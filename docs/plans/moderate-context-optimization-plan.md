# Implementation Plan: Moderate Context Optimization

> Generated by `/PACT:plan-mode` on 2026-01-15
> Status: PENDING APPROVAL

<!-- Status Lifecycle:
     PENDING APPROVAL â†’ APPROVED â†’ IN_PROGRESS â†’ IMPLEMENTED
                    â†˜ SUPERSEDED (if replaced by newer plan)
                    â†˜ BLOCKED (if unresolved conflicts)
-->

## Summary

Break up the 1,085-line `pact-protocols.md` into targeted files so agents and commands import only the context they need. This moderate approach extracts **2 new files** while keeping `pact-protocols.md` as the orchestrator referenceâ€”achieving ~85% context reduction for agents with minimal maintenance overhead.

---

## Problem Statement

**Current state:** Every PACT agent and command that references `pact-protocols.md` loads all 1,085 lines regardless of what they actually need:

| Consumer | What They Need | What They Load | Waste |
|----------|----------------|----------------|-------|
| 7 Agents | S1 Autonomy (~75 lines) | 1,085 lines | ~93% |
| plan-mode.md | Variety (~60 lines) | 1,085 lines | ~94% |
| orchestrate.md | Multiple sections | 1,085 lines | Varies |

**Goal:** Enable targeted imports so agents load ~100 lines instead of 1,085.

---

## Specialist Perspectives

### ðŸ“‹ Preparation Phase
**Effort**: Low

#### Research Completed
- [x] File sizes measured (pact-protocols.md = 1,085 lines)
- [x] Reference patterns analyzed (24+ @-references across 10 files)
- [x] Agent-specific sections identified (S1 Autonomy, Self-Coordination, Algedonic pointer)
- [x] Existing patterns confirmed (algedonic.md already extractedâ€”proves pattern works)

#### Dependencies to Map
- All 7 agent files reference `@~/.claude/protocols/pact-protocols.md`
- orchestrate.md has 6 references to specific sections
- plan-mode.md has 1 reference (variety management)
- pact-plugin/ must mirror all changes

---

### ðŸ—ï¸ Architecture Phase
**Effort**: Low

#### Proposed File Structure

```
~/.claude/protocols/
â”œâ”€â”€ pact-protocols.md        # Refactored: Orchestrator reference (~950 lines)
â”œâ”€â”€ pact-agent-protocols.md  # NEW: For all agents (~100 lines)
â”œâ”€â”€ pact-variety.md          # NEW: For orchestrate/plan-mode (~80 lines)
â””â”€â”€ algedonic.md             # Unchanged (already extracted)
```

#### Content Distribution

| File | Content | Lines | Consumers |
|------|---------|-------|-----------|
| **pact-agent-protocols.md** (NEW) | S1 Autonomy & Recursion (full), Self-Coordination (from S2), Phase Handoffs, Algedonic quick-ref | ~100 | All 7 agents |
| **pact-variety.md** (NEW) | Variety Management (full), PACT Workflow Family table | ~80 | orchestrate.md, plan-mode.md |
| **pact-protocols.md** (refactored) | S5 Policy, S4 Checkpoints, S3/S4 Tension, S2 Coordination (minus Self-Coordination), S3* Audit, Workflow protocols, Decision logs, Documentation locations | ~950 | Orchestrator only |

#### Design Approach

**Consumer-aligned partitioning**: Group content by who needs it rather than by VSM system. This is the simplest mental model:
- "Agent file" = What agents need to know
- "Variety file" = What commands need for workflow selection
- "Main file" = Orchestrator's complete reference

#### Key Decisions

| Decision | Options | Recommendation | Rationale |
|----------|---------|----------------|-----------|
| How many files? | 2 new / 4 new / 8 new | **2 new** | Truly moderate; highest ROI with lowest overhead |
| Naming convention | VSM-aligned / Consumer-aligned | **Consumer-aligned** | More intuitive (`pact-agent-protocols` vs `s1-autonomy`) |
| What stays in main file? | Everything else / Slim index only | **Everything else** | Orchestrator still benefits from having full reference |

#### Interface Contracts

Each new file includes:
```markdown
# {Title}

> **Purpose**: {One line}
> **Referenced by**: {Consumer list}
> **See also**: @~/.claude/protocols/pact-protocols.md for full orchestration protocols
```

---

### ðŸ’» Code Phase
**Effort**: Low-Medium

#### Files to Create

| File | Purpose |
|------|---------|
| `.claude/protocols/pact-agent-protocols.md` | Agent-focused protocols: autonomy, coordination, handoffs |
| `.claude/protocols/pact-variety.md` | Variety scoring and workflow selection |

#### Files to Modify

| File | Changes |
|------|---------|
| `.claude/protocols/pact-protocols.md` | Add index header pointing to extracted files; minor cleanup |
| `.claude/agents/pact-architect.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-backend-coder.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-frontend-coder.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-database-engineer.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-test-engineer.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-preparer.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/agents/pact-n8n.md` | Update refs: `pact-protocols.md` â†’ `pact-agent-protocols.md` |
| `.claude/commands/PACT/orchestrate.md` | Update variety refs â†’ `pact-variety.md` |
| `.claude/commands/PACT/plan-mode.md` | Update variety refs â†’ `pact-variety.md` |
| `pact-plugin/protocols/` | Mirror new protocol files |
| `pact-plugin/agents/` | Mirror agent reference updates |

#### Implementation Sequence

1. Create `pact-agent-protocols.md` with extracted content
2. Create `pact-variety.md` with extracted content
3. Add index header to `pact-protocols.md` pointing to new files
4. Update all 7 agent files (parallel-safe: different files)
5. Update orchestrate.md and plan-mode.md
6. Sync to pact-plugin/ directory

---

### ðŸ§ª Test Phase
**Effort**: Low

#### Test Scenarios

| Scenario | Type | Priority |
|----------|------|----------|
| All @-references resolve to existing files | Validation | P0 |
| No content lost during extraction | Validation | P0 |
| Agent can read `pact-agent-protocols.md` | Smoke | P0 |
| orchestrate.md can read `pact-variety.md` | Smoke | P0 |
| No duplicate content across files | Validation | P1 |

#### Coverage Targets
- Reference resolution: 100%
- Content preservation: 100% (verified by diff)

#### Validation Approach

**Hybrid**: Automated grep for reference inventory + manual spot-check of key consumers

```bash
# Pre-change baseline
grep -r "@~/.claude/protocols" .claude/ > baseline-refs.txt

# Post-change validation
for ref in $(grep -oh "@~/.claude/protocols/[^)\" ]*" .claude/**/*.md); do
  filepath="${ref#@}"
  filepath="${filepath/#\~/$HOME}"
  [[ ! -f "$filepath" ]] && echo "BROKEN: $ref"
done
```

---

## Synthesized Implementation Roadmap

### Phase Sequence

```
Phase 1: Extract Agent Protocols (Low Risk)
â”œâ”€â”€ Create pact-agent-protocols.md
â””â”€â”€ Content: S1 Autonomy + Self-Coordination + Phase Handoffs + Algedonic quick-ref
         â”‚
         â–¼ CHECKPOINT: New file exists and is well-formed
         â”‚
Phase 2: Extract Variety Management (Low Risk)
â”œâ”€â”€ Create pact-variety.md
â””â”€â”€ Content: Variety Management + Workflow Family table
         â”‚
         â–¼ CHECKPOINT: New file exists and is well-formed
         â”‚
Phase 3: Update Index (Low Risk)
â”œâ”€â”€ Add header to pact-protocols.md
â””â”€â”€ List extracted files with purposes
         â”‚
         â–¼ CHECKPOINT: Main file still coherent
         â”‚
Phase 4: Update Agent References (Medium Risk)
â”œâ”€â”€ Update all 7 agent files
â””â”€â”€ Change @pact-protocols.md â†’ @pact-agent-protocols.md (targeted refs only)
         â”‚
         â–¼ CHECKPOINT: All agent refs resolve
         â”‚
Phase 5: Update Command References (Low Risk)
â”œâ”€â”€ Update orchestrate.md variety refs
â””â”€â”€ Update plan-mode.md variety ref
         â”‚
         â–¼ CHECKPOINT: All command refs resolve
         â”‚
Phase 6: Plugin Sync (Low Risk)
â”œâ”€â”€ Copy new protocols to pact-plugin/protocols/
â””â”€â”€ Copy updated agents to pact-plugin/agents/
         â”‚
         â–¼ FINAL VALIDATION
```

### Commit Sequence (Proposed)

> **Note**: This sequence represents the intended final git history order, **not** the execution order. Independent commits may be implemented in parallel.

1. `feat(protocols): extract agent-focused protocols to pact-agent-protocols.md` â€” S1 Autonomy, Self-Coordination, Phase Handoffs
2. `feat(protocols): extract variety management to pact-variety.md` â€” Variety scoring, workflow family
3. `refactor(protocols): add index header to pact-protocols.md` â€” Point to extracted files
4. `refactor(agents): update 7 agent files with targeted protocol refs` â€” All agents use new file
5. `refactor(commands): update orchestrate and plan-mode with targeted refs` â€” Commands use variety file
6. `chore(plugin): sync protocol and agent changes to pact-plugin/` â€” Mirror for distribution

---

## Cross-Cutting Concerns

| Concern | Status | Notes |
|---------|--------|-------|
| Security | N/A | No security implications |
| Performance | Ready | This is a context reduction optimization |
| Accessibility | N/A | Documentation only |
| Observability | N/A | No runtime implications |

---

## Open Questions

### Require User Decision

None â€” straightforward moderate optimization with clear scope.

### Require Further Research

- [ ] **Token measurement**: How to verify actual token savings post-implementation? (Can defer to TEST phase)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Broken @-references after update | Low | High | Pre-change baseline + automated validation script |
| Content lost during extraction | Low | Medium | Section-by-section diff before/after |
| Increased maintenance overhead | Low | Low | Only 2 new files; clear purposes |
| Agent needs content not in extracted file | Low | Medium | Include all agent-relevant sections; main file remains available |

---

## Expected Outcomes

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Agent context load | 1,085 lines | ~100 lines | **~90% reduction** |
| plan-mode context load | 1,085 lines | ~80 lines | **~93% reduction** |
| orchestrate.md (variety refs) | 1,085 lines | ~80 lines | **~93% reduction** |
| Files to maintain | 1 | 3 | +2 files (moderate overhead) |
| Total protocol lines | 1,085 | 1,085 | No loss (redistributed) |

---

## Scope Assessment

- **Overall Complexity**: Low-Medium
- **Estimated Files**: 2 new, 12 modified (7 agents + 2 commands + pact-protocols + plugin mirrors)
- **Specialists Required**: pact-preparer (minimal), orchestrator for file edits
- **External Dependencies**: None
- **Estimated Time**: 2-3 hours implementation + 1 hour validation

---

## Comparison to Previous Plan

This plan supersedes the more comprehensive `context-architecture-protocols-plan.md` (PR #71):

| Aspect | Previous Plan | This Plan |
|--------|---------------|-----------|
| New files | 8 | 2 |
| Scope | Full VSM-aligned partitioning | Consumer-aligned extraction |
| Complexity | High | Low-Medium |
| Maintenance overhead | High | Low |
| Agent savings | ~90% | ~90% |
| Time estimate | 6-7 hours | 2-3 hours |

**Trade-off**: Similar agent context savings with ~60% less implementation effort and ongoing maintenance.

---

## Next Steps

To implement this plan after approval:
```
/PACT:orchestrate implement moderate context optimization per approved plan
```

The orchestrator should reference this plan during execution.
