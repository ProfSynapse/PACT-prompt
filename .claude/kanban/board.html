<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PACT Kanban</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #30363d;
    }
    h1 { font-size: 1.4em; font-weight: 600; }
    .status { font-size: 0.85em; color: #8b949e; }
    .status.live { color: #3fb950; }
    .status.live::before { content: '‚óè '; }

    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 1200px;
    }
    .column {
      background: #161b22;
      border-radius: 8px;
      padding: 12px;
      min-height: 400px;
    }
    .column-header {
      font-size: 0.9em;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .count {
      background: #30363d;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8em;
    }

    .task {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .task:hover { border-color: #58a6ff; }
    .task.running { border-left: 3px solid #f0883e; }
    .task.done { border-left: 3px solid #3fb950; opacity: 0.8; }
    .task.error { border-left: 3px solid #f85149; }

    .task-title {
      font-size: 0.85em;
      font-weight: 500;
      margin-bottom: 6px;
      word-break: break-word;
    }
    .task-meta {
      font-size: 0.75em;
      color: #8b949e;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .agent-badge {
      background: #1f6feb33;
      color: #58a6ff;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 0.75em;
    }

    .detail-panel {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 550px;
      height: 100vh;
      background: #161b22;
      border-left: 1px solid #30363d;
      padding: 20px;
      overflow-y: auto;
    }
    .detail-panel.open { display: block; }
    .detail-panel h2 {
      font-size: 1em;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
    }
    .close-btn {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      font-size: 1.2em;
    }
    .detail-row {
      margin-bottom: 12px;
    }
    .detail-label {
      font-size: 0.75em;
      color: #8b949e;
      margin-bottom: 3px;
    }
    .detail-value {
      font-size: 0.85em;
      word-break: break-word;
    }

    .empty {
      color: #484f58;
      font-size: 0.8em;
      text-align: center;
      padding: 30px 10px;
    }

    .agents-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .agent-status {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.8em;
    }
    .agent-status.busy { border-color: #f0883e; }
    .agent-status.idle { border-color: #3fb950; }

    /* Transcript styles */
    .transcript-section {
      margin-top: 20px;
      border-top: 1px solid #30363d;
      padding-top: 15px;
    }
    .transcript-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .transcript-header h3 {
      font-size: 0.9em;
      color: #8b949e;
    }
    .transcript-status {
      font-size: 0.75em;
      color: #8b949e;
    }
    .transcript-status.polling { color: #f0883e; }
    .transcript-status.polling::before { content: '‚Üª '; }
    .transcript-content {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.8em;
    }
    .transcript-msg {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #21262d;
    }
    .transcript-msg:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .transcript-msg.text {
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .transcript-msg.tool {
      background: #1f6feb15;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .tool-name {
      color: #58a6ff;
      font-weight: 600;
    }
    .tool-input {
      color: #8b949e;
      margin-top: 4px;
      font-size: 0.9em;
    }
    .transcript-empty {
      color: #484f58;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üõ†Ô∏è PACT Kanban</h1>
    <div class="status" id="status">Disconnected</div>
  </header>

  <div class="agents-bar" id="agents"></div>

  <div class="board">
    <div class="column">
      <div class="column-header">
        Queued <span class="count" id="queued-count">0</span>
      </div>
      <div id="queued"></div>
    </div>
    <div class="column">
      <div class="column-header">
        In Progress <span class="count" id="running-count">0</span>
      </div>
      <div id="running"></div>
    </div>
    <div class="column">
      <div class="column-header">
        Done <span class="count" id="done-count">0</span>
      </div>
      <div id="done"></div>
    </div>
  </div>

  <div class="detail-panel" id="detail">
    <h2>
      <span>Task Details</span>
      <button class="close-btn" onclick="closeDetail()">√ó</button>
    </h2>
    <div id="detail-content"></div>
  </div>

  <script>
    const STATE_FILE = 'state.json';
    let state = { agents: {}, tasks: [] };
    let selectedTask = null;
    let transcriptPollInterval = null;

    async function loadState() {
      try {
        const res = await fetch(STATE_FILE + '?t=' + Date.now());
        if (res.ok) {
          state = await res.json();
          render();
          setStatus(true);
        }
      } catch (e) {
        setStatus(false);
      }
    }

    function setStatus(connected) {
      const el = document.getElementById('status');
      if (connected) {
        el.textContent = 'Live';
        el.className = 'status live';
      } else {
        el.textContent = 'Disconnected';
        el.className = 'status';
      }
    }

    function render() {
      renderAgents();
      renderTasks();
    }

    function renderAgents() {
      const el = document.getElementById('agents');
      const agents = Object.entries(state.agents || {});
      if (agents.length === 0) {
        el.innerHTML = '';
        return;
      }
      el.innerHTML = agents.map(([name, info]) => `
        <div class="agent-status ${info.status}">
          ${getAgentIcon(name)} ${name}: ${info.status}
        </div>
      `).join('');
    }

    function getAgentIcon(name) {
      const icons = {
        'pact-preparer': 'üìö',
        'pact-architect': 'üèõÔ∏è',
        'pact-backend-coder': 'üíª',
        'pact-frontend-coder': 'üé®',
        'pact-database-engineer': 'üóÑÔ∏è',
        'pact-test-engineer': 'üß™',
        'Explore': 'üîç',
        'general-purpose': '‚öôÔ∏è',
        'claude-code-guide': 'üìñ'
      };
      return icons[name] || 'ü§ñ';
    }

    function renderTasks() {
      const queued = state.tasks.filter(t => t.status === 'queued');
      const running = state.tasks.filter(t => t.status === 'running');
      const done = state.tasks.filter(t => t.status === 'done' || t.status === 'error');

      document.getElementById('queued-count').textContent = queued.length;
      document.getElementById('running-count').textContent = running.length;
      document.getElementById('done-count').textContent = done.length;

      document.getElementById('queued').innerHTML = queued.length
        ? queued.map(taskCard).join('')
        : '<div class="empty">No queued tasks</div>';
      document.getElementById('running').innerHTML = running.length
        ? running.map(taskCard).join('')
        : '<div class="empty">No running tasks</div>';
      document.getElementById('done').innerHTML = done.length
        ? done.slice().reverse().slice(0, 20).map(taskCard).join('')
        : '<div class="empty">No completed tasks</div>';
    }

    function taskCard(task) {
      const elapsed = task.started_at ? formatElapsed(task.started_at, task.completed_at) : '';
      return `
        <div class="task ${task.status}" onclick='showDetail(${JSON.stringify(task).replace(/'/g, "&#39;")})'>
          <div class="task-title">${escapeHtml(task.description || task.id)}</div>
          <div class="task-meta">
            <span class="agent-badge">${getAgentIcon(task.agent)} ${task.agent || 'unknown'}</span>
            ${elapsed ? `<span>${elapsed}</span>` : ''}
          </div>
        </div>
      `;
    }

    function showDetail(task) {
      selectedTask = task;

      // Stop any existing transcript polling
      if (transcriptPollInterval) {
        clearInterval(transcriptPollInterval);
        transcriptPollInterval = null;
      }

      const el = document.getElementById('detail-content');
      el.innerHTML = `
        <div class="detail-row">
          <div class="detail-label">ID</div>
          <div class="detail-value">${task.id}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Description</div>
          <div class="detail-value">${escapeHtml(task.description || 'N/A')}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Agent</div>
          <div class="detail-value">${getAgentIcon(task.agent)} ${task.agent || 'unknown'}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Status</div>
          <div class="detail-value">${task.status}${task.status === 'running' ? ' ‚è≥' : ''}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Duration</div>
          <div class="detail-value">${formatElapsed(task.started_at, task.completed_at)}</div>
        </div>
        ${task.prompt ? `
        <div class="detail-row">
          <div class="detail-label">Prompt</div>
          <div class="detail-value" style="white-space: pre-wrap; max-height: 150px; overflow-y: auto; background: #0d1117; padding: 8px; border-radius: 4px;">${escapeHtml(task.prompt)}</div>
        </div>
        ` : ''}
        <div class="transcript-section">
          <div class="transcript-header">
            <h3>üìú Transcript</h3>
            <span class="transcript-status" id="transcript-status"></span>
          </div>
          <div class="transcript-content" id="transcript-content">
            <div class="transcript-empty">Loading...</div>
          </div>
        </div>
      `;
      document.getElementById('detail').classList.add('open');

      // Load transcript
      loadTranscript(task);

      // Poll for updates if task is running
      if (task.status === 'running') {
        transcriptPollInterval = setInterval(() => loadTranscript(task), 3000);
        document.getElementById('transcript-status').textContent = 'Live';
        document.getElementById('transcript-status').className = 'transcript-status polling';
      }
    }

    async function loadTranscript(task) {
      const contentEl = document.getElementById('transcript-content');
      const statusEl = document.getElementById('transcript-status');

      if (!task.transcript_path) {
        contentEl.innerHTML = '<div class="transcript-empty">No transcript available yet</div>';
        return;
      }

      try {
        const res = await fetch(`/api/transcript?path=${encodeURIComponent(task.transcript_path)}&t=${Date.now()}`);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (!data.messages || data.messages.length === 0) {
          contentEl.innerHTML = '<div class="transcript-empty">Transcript empty</div>';
          return;
        }

        contentEl.innerHTML = data.messages.map(msg => {
          if (msg.type === 'text') {
            return `<div class="transcript-msg text">${escapeHtml(msg.content)}</div>`;
          } else if (msg.type === 'tool') {
            return `
              <div class="transcript-msg tool">
                <span class="tool-name">üîß ${escapeHtml(msg.tool)}</span>
                <div class="tool-input">${escapeHtml(msg.input)}</div>
              </div>
            `;
          }
          return '';
        }).join('');

        if (statusEl && task.status !== 'running') {
          statusEl.textContent = `${data.raw_lines} entries`;
          statusEl.className = 'transcript-status';
        }

        // Auto-scroll to bottom
        contentEl.scrollTop = contentEl.scrollHeight;

      } catch (e) {
        contentEl.innerHTML = `<div class="transcript-empty">Could not load transcript: ${escapeHtml(e.message)}</div>`;
      }
    }

    function closeDetail() {
      selectedTask = null;
      if (transcriptPollInterval) {
        clearInterval(transcriptPollInterval);
        transcriptPollInterval = null;
      }
      document.getElementById('detail').classList.remove('open');
    }

    function formatElapsed(start, end) {
      if (!start) return 'N/A';
      const startTime = new Date(start).getTime();
      const endTime = end ? new Date(end).getTime() : Date.now();
      const seconds = Math.floor((endTime - startTime) / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
      return `${Math.floor(minutes / 60)}h ${minutes % 60}m`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Poll for state updates
    loadState();
    setInterval(loadState, 2000);
  </script>
</body>
</html>
